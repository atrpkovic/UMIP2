<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UMIP 2.0 - Priority Tire Marketing Intelligence</title>
    <link rel="icon" type="image/png" href="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcR23H4FKwnIX7I8zPuJHaeum7CUc6Ko2wOO-A&s">
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- Left Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>Conversations</h2>
                <div class="sidebar-actions">
                    <button class="new-chat-btn" id="new-chat-btn" title="New chat">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 5v14M5 12h14"/>
                        </svg>
                    </button>
                    <button class="clear-all-btn" id="clear-history-btn" title="Clear all conversations">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="sidebar-content" id="history-list">
                <!-- History items populated by JS -->
            </div>
            <div class="downloads-section">
                <div class="downloads-header">Downloads</div>
                <div id="downloads-list">
                    <div class="no-downloads">No downloads yet</div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="main-content">
            <header>
                <div class="header-left">
                    <button class="sidebar-toggle" id="sidebar-toggle" title="Toggle sidebar">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 12h18M3 6h18M3 18h18"/>
                        </svg>
                    </button>
                    <div class="logo">
                        <h1><span>UMIP</span> 2.0</h1>
                    </div>
                    <span class="subtitle">Priority Tire Marketing Intelligence</span>
                </div>
                <div class="header-right">
                    <button class="theme-toggle" id="theme-toggle" title="Toggle theme">
                        <svg class="moon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                        <svg class="sun" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
                        </svg>
                    </button>
                </div>
            </header>
            
            <main id="messages">
                <div class="message assistant">
                    <div class="message-content">
                        Hi! I'm your marketing data assistant. Ask me anything about your 
                        Google Shopping data, GA4 analytics, ad campaigns, inventory, or SEO rankings.
                    </div>
                </div>
            </main>
            
            <footer>
                <form id="chat-form">
                    <input 
                        type="text" 
                        id="user-input" 
                        placeholder="Ask a question about your data..."
                        autocomplete="off"
                    >
                    <button type="submit" id="send-btn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 2L11 13M22 2L15 22L11 13M11 13L2 9L22 2"/>
                        </svg>
                    </button>
                </form>
            </footer>
        </div>
    </div>

    <!-- Data Panel (slides in from right) -->
    <div class="data-panel" id="data-panel">
        <div class="data-panel-header">
            <h3>Data View <span id="data-row-count"></span></h3>
            <div class="data-panel-actions">
                <button class="panel-btn" id="copy-data-btn">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                    </svg>
                    Copy
                </button>
                <button class="panel-btn primary" id="download-csv-btn">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/>
                    </svg>
                    Download CSV
                </button>
                <button class="panel-close" id="panel-close">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>
        </div>
        <div class="data-panel-content">
            <div class="data-table-container" id="data-table-container">
                <!-- Table populated by JS -->
            </div>
        </div>
    </div>

    <!-- SQL Modal -->
    <div class="sql-modal" id="sql-modal">
        <div class="sql-modal-header">
            <h3>SQL Query</h3>
            <button class="sql-modal-close" id="sql-modal-close">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <pre><code id="sql-content"></code></pre>
    </div>

    <!-- Chart Modal -->
    <div class="chart-modal" id="chart-modal">
        <div class="chart-modal-header">
            <h3 id="chart-title">Seasonality Trend</h3>
            <button class="chart-modal-close" id="chart-modal-close">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <div class="chart-container">
            <canvas id="seasonality-chart"></canvas>
        </div>
    </div>

    <!-- PIN Setup Banner -->
    <div class="pin-banner" id="pin-banner" style="display: none;">
        <div class="pin-banner-content">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="flex-shrink: 0;">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
            </svg>
            <div class="pin-banner-text">
                <strong>Protect your conversations!</strong>
                <span class="pin-tooltip">Set a PIN to access your data from any browser or after clearing cache.</span>
            </div>
            <button class="pin-banner-btn" id="setup-pin-btn">Set PIN</button>
            <button class="pin-banner-close" id="pin-banner-close" title="Dismiss">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
            </button>
        </div>
    </div>

    <!-- PIN Setup Modal -->
    <div class="pin-modal" id="pin-modal" style="display: none;">
        <div class="pin-modal-content">
            <div class="pin-modal-header">
                <h3>Set Your PIN</h3>
                <button class="pin-modal-close" id="pin-modal-close">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="pin-modal-body">
                <p>Choose a 4-8 digit PIN to backup your user ID. You'll need this PIN to access your conversations from other browsers or after clearing cache.</p>
                <input type="password" id="pin-input" placeholder="Enter 4-8 digit PIN" maxlength="8" pattern="[0-9]*" inputmode="numeric">
                <input type="password" id="pin-confirm" placeholder="Confirm PIN" maxlength="8" pattern="[0-9]*" inputmode="numeric">
                <div class="pin-error" id="pin-error" style="display: none;"></div>
            </div>
            <div class="pin-modal-footer">
                <button class="btn-secondary" id="pin-cancel-btn">Cancel</button>
                <button class="btn-primary" id="pin-save-btn">Save PIN</button>
            </div>
        </div>
    </div>

    <!-- PIN Recovery Modal -->
    <div class="pin-modal" id="pin-recovery-modal" style="display: none;">
        <div class="pin-modal-content">
            <div class="pin-modal-header">
                <h3>Recover Your Conversations</h3>
            </div>
            <div class="pin-modal-body">
                <p>Enter your PIN to restore your conversations, or start fresh with a new account.</p>
                <input type="password" id="recovery-pin-input" placeholder="Enter your PIN" maxlength="8" pattern="[0-9]*" inputmode="numeric">
                <div class="pin-error" id="recovery-pin-error" style="display: none;"></div>
            </div>
            <div class="pin-modal-footer">
                <button class="btn-secondary" id="recovery-cancel-btn">Start Fresh</button>
                <button class="btn-primary" id="recovery-submit-btn">Recover</button>
            </div>
        </div>
    </div>

    <!-- Overlay -->
    <div class="overlay" id="overlay"></div>

    <script>
        // State
        let currentData = null;
        let currentSql = null;
        let currentChart = null;

        // Conversation-based state (replaces queryHistory)
        let conversations = JSON.parse(localStorage.getItem('conversations') || '[]');
        let activeConversationId = localStorage.getItem('activeConversationId') || null;
        let lastActivityTime = Date.now();
        const SESSION_TIMEOUT = 30 * 60 * 1000; // 30 minutes in milliseconds

        // User ID management (Browser-based UUID with optional PIN backup)
        let userId = localStorage.getItem('userId') || null;

        // Generate UUID if not present
        function generateUserId() {
            return 'user-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        }

        // Initialize user ID on first visit
        if (!userId) {
            userId = generateUserId();
            localStorage.setItem('userId', userId);
            console.log('Generated new user ID:', userId);

            // Show PIN setup banner after a short delay
            setTimeout(() => showPinSetupBanner(), 2000);
        }

        let downloads = JSON.parse(localStorage.getItem('downloads') || '[]');

        // Migration: Convert old queryHistory to conversations if needed
        const oldHistory = JSON.parse(localStorage.getItem('queryHistory') || '[]');
        if (oldHistory.length > 0 && conversations.length === 0) {
            // Convert each old query to a single-message conversation
            oldHistory.forEach(item => {
                const convId = `conv-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                conversations.push({
                    id: convId,
                    title: item.query.substring(0, 50) + (item.query.length > 50 ? '...' : ''),
                    created: new Date().toISOString(),
                    lastActive: new Date().toISOString(),
                    messages: [
                        {
                            role: 'user',
                            content: item.query,
                            timestamp: item.time || new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                        },
                        ...(item.answer ? [{
                            role: 'assistant',
                            content: item.answer,
                            timestamp: item.time || new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                            sql: item.sql || null,
                            dataRowCount: item.dataRowCount || 0,
                            dataColumns: item.dataColumns || null
                        }] : [])
                    ]
                });
            });
            localStorage.setItem('conversations', JSON.stringify(conversations));
            localStorage.removeItem('queryHistory'); // Clean up old format
        }

        // DOM Elements
        const messagesDiv = document.getElementById('messages');
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const themeToggle = document.getElementById('theme-toggle');
        const dataPanel = document.getElementById('data-panel');
        const panelClose = document.getElementById('panel-close');
        const overlay = document.getElementById('overlay');
        const sqlModal = document.getElementById('sql-modal');
        const sqlModalClose = document.getElementById('sql-modal-close');
        const sqlContent = document.getElementById('sql-content');
        const chartModal = document.getElementById('chart-modal');
        const chartModalClose = document.getElementById('chart-modal-close');
        const chartTitle = document.getElementById('chart-title');
        const historyList = document.getElementById('history-list');
        const downloadsList = document.getElementById('downloads-list');
        const dataTableContainer = document.getElementById('data-table-container');
        const dataRowCount = document.getElementById('data-row-count');
        const downloadCsvBtn = document.getElementById('download-csv-btn');
        const copyDataBtn = document.getElementById('copy-data-btn');

        // Initialize theme
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);

        // Theme toggle
        themeToggle.addEventListener('click', () => {
            const current = document.documentElement.getAttribute('data-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
        });

        // Sidebar toggle
        sidebarToggle.addEventListener('click', () => {
            sidebar.classList.toggle('collapsed');
        });

        // Panel close
        panelClose.addEventListener('click', closeDataPanel);
        overlay.addEventListener('click', () => {
            closeDataPanel();
            closeSqlModal();
            closeChartModal();
        });

        // SQL Modal
        sqlModalClose.addEventListener('click', closeSqlModal);

        function closeSqlModal() {
            sqlModal.classList.remove('active');
            overlay.classList.remove('active');
        }

        // Chart Modal
        chartModalClose.addEventListener('click', closeChartModal);

        function closeChartModal() {
            chartModal.classList.remove('active');
            overlay.classList.remove('active');
        }

        function closeDataPanel() {
            dataPanel.classList.remove('active');
            overlay.classList.remove('active');
        }

        // Detect if data is chartable (has date/time + numeric columns)
        function detectChartableData(data) {
            if (!data || data.length < 2) return null;
            
            const columns = Object.keys(data[0]);
            
            // Look for date/time columns
            const dateColumns = columns.filter(col => 
                /date|time|month|week|year|period|quarter/i.test(col)
            );
            
            // Look for numeric columns suitable for charting
            const numericColumns = columns.filter(col => {
                if (dateColumns.includes(col)) return false;
                const sample = data[0][col];
                return typeof sample === 'number' || 
                       (typeof sample === 'string' && !isNaN(parseFloat(sample)));
            });
            
            // Check for specific patterns
            const hasInterest = columns.some(c => /interest|trend|volume|index/i.test(c));
            const hasSeasonality = columns.some(c => /season|month|week/i.test(c));
            
            if (dateColumns.length > 0 && numericColumns.length > 0) {
                return {
                    type: hasInterest || hasSeasonality ? 'seasonality' : 'timeseries',
                    dateColumn: dateColumns[0],
                    valueColumns: numericColumns.slice(0, 3), // Max 3 series
                    labelColumn: columns.find(c => /keyword|name|label|campaign/i.test(c))
                };
            }
            
            // Check for monthly seasonality pattern (MONTH + value)
            const monthCol = columns.find(c => /^month$/i.test(c));
            if (monthCol && numericColumns.length > 0) {
                return {
                    type: 'monthly',
                    dateColumn: monthCol,
                    valueColumns: numericColumns.slice(0, 3),
                    labelColumn: columns.find(c => /keyword|name|label/i.test(c))
                };
            }
            
            return null;
        }

        // Render chart
        function renderChart(data, chartConfig, title = 'Trend Analysis') {
            chartTitle.textContent = title;
            
            // Destroy existing chart
            if (currentChart) {
                currentChart.destroy();
            }
            
            const ctx = document.getElementById('seasonality-chart').getContext('2d');
            
            // Prepare data
            let labels, datasets;
            
            if (chartConfig.type === 'monthly') {
                // Sort by month
                const monthOrder = ['January', 'February', 'March', 'April', 'May', 'June', 
                                   'July', 'August', 'September', 'October', 'November', 'December'];
                const monthAbbr = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                                  'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                
                // Group by keyword if present
                if (chartConfig.labelColumn) {
                    const grouped = {};
                    data.forEach(row => {
                        const keyword = row[chartConfig.labelColumn];
                        if (!grouped[keyword]) grouped[keyword] = {};
                        const monthIdx = typeof row[chartConfig.dateColumn] === 'number' 
                            ? row[chartConfig.dateColumn] - 1
                            : monthOrder.findIndex(m => m.toLowerCase().startsWith(String(row[chartConfig.dateColumn]).toLowerCase()));
                        if (monthIdx >= 0) {
                            grouped[keyword][monthIdx] = parseFloat(row[chartConfig.valueColumns[0]]) || 0;
                        }
                    });
                    
                    labels = monthAbbr;
                    datasets = Object.entries(grouped).slice(0, 5).map(([keyword, values], idx) => ({
                        label: keyword,
                        data: monthAbbr.map((_, i) => values[i] || 0),
                        borderColor: getChartColor(idx),
                        backgroundColor: getChartColor(idx, 0.1),
                        tension: 0.3,
                        fill: false
                    }));
                } else {
                    labels = data.map(row => {
                        const m = row[chartConfig.dateColumn];
                        return typeof m === 'number' ? monthAbbr[m - 1] : m;
                    });
                    datasets = chartConfig.valueColumns.map((col, idx) => ({
                        label: col,
                        data: data.map(row => parseFloat(row[col]) || 0),
                        borderColor: getChartColor(idx),
                        backgroundColor: getChartColor(idx, 0.1),
                        tension: 0.3,
                        fill: idx === 0
                    }));
                }
            } else {
                // Time series
                const sortedData = [...data].sort((a, b) => 
                    new Date(a[chartConfig.dateColumn]) - new Date(b[chartConfig.dateColumn])
                );
                
                // Group by keyword if present
                if (chartConfig.labelColumn) {
                    const grouped = {};
                    sortedData.forEach(row => {
                        const keyword = row[chartConfig.labelColumn];
                        if (!grouped[keyword]) grouped[keyword] = [];
                        grouped[keyword].push({
                            date: row[chartConfig.dateColumn],
                            value: parseFloat(row[chartConfig.valueColumns[0]]) || 0
                        });
                    });
                    
                    // Get all unique dates
                    const allDates = [...new Set(sortedData.map(r => r[chartConfig.dateColumn]))].sort();
                    labels = allDates.map(d => formatDate(d));
                    
                    datasets = Object.entries(grouped).slice(0, 5).map(([keyword, values], idx) => {
                        const valueMap = {};
                        values.forEach(v => valueMap[v.date] = v.value);
                        return {
                            label: keyword,
                            data: allDates.map(d => valueMap[d] || 0),
                            borderColor: getChartColor(idx),
                            backgroundColor: getChartColor(idx, 0.1),
                            tension: 0.3,
                            fill: false
                        };
                    });
                } else {
                    labels = sortedData.map(row => formatDate(row[chartConfig.dateColumn]));
                    datasets = chartConfig.valueColumns.map((col, idx) => ({
                        label: col,
                        data: sortedData.map(row => parseFloat(row[col]) || 0),
                        borderColor: getChartColor(idx),
                        backgroundColor: getChartColor(idx, 0.1),
                        tension: 0.3,
                        fill: idx === 0
                    }));
                }
            }
            
            currentChart = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary').trim()
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim()
                            },
                            grid: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim()
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim()
                            },
                            grid: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim()
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
            
            chartModal.classList.add('active');
            overlay.classList.add('active');
        }
        
        function getChartColor(index, alpha = 1) {
            const colors = [
                `rgba(242, 166, 29, ${alpha})`,   // Priority Tire orange
                `rgba(59, 130, 246, ${alpha})`,   // Blue
                `rgba(16, 185, 129, ${alpha})`,   // Green
                `rgba(239, 68, 68, ${alpha})`,    // Red
                `rgba(139, 92, 246, ${alpha})`    // Purple
            ];
            return colors[index % colors.length];
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            if (isNaN(d)) return dateStr;
            return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function openChartModal(data, title) {
            const chartConfig = detectChartableData(data);
            if (chartConfig) {
                renderChart(data, chartConfig, title);
            }
        }

        function openDataPanel(data) {
            currentData = data;
            currentPage = 1; // Reset to first page when opening new data
            columnOrder = []; // Reset column order
            sortColumn = null; // Reset sorting
            sortDirection = 'asc';
            dataRowCount.textContent = `(${data.length} rows)`;
            dataTableContainer.innerHTML = createTable(data);
            dataPanel.classList.add('active');
            overlay.classList.add('active');
        }

        function openSqlModal(sql) {
            sqlContent.textContent = sql;
            sqlModal.classList.add('active');
            overlay.classList.add('active');
        }

        // Rename conversation
        function renameConversation(convId, newTitle) {
            const conv = conversations.find(c => c.id === convId);
            if (!conv) return;

            conv.title = newTitle.trim() || conv.title; // Keep old title if empty
            saveConversations();
            renderHistory();
        }

        // Render history
        function renderHistory() {
            if (conversations.length === 0) {
                historyList.innerHTML = '<div class="no-downloads" style="padding: 12px;">No conversations yet</div>';
                return;
            }

            historyList.innerHTML = conversations.map((conv) => {
                const messageCount = conv.messages.length;
                const isActive = conv.id === activeConversationId;
                const activeClass = isActive ? ' active' : '';

                // Format last active time
                const lastActive = new Date(conv.lastActive);
                const now = new Date();
                const diffMs = now - lastActive;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);

                let timeText;
                if (diffMins < 1) timeText = 'Just now';
                else if (diffMins < 60) timeText = `${diffMins}m ago`;
                else if (diffHours < 24) timeText = `${diffHours}h ago`;
                else if (diffDays < 7) timeText = `${diffDays}d ago`;
                else timeText = lastActive.toLocaleDateString();

                return `
                <div class="history-item${activeClass}" data-conv-id="${conv.id}">
                    <div class="history-item-content">
                        <div class="query" data-conv-id="${conv.id}">${escapeHtml(conv.title)}</div>
                        <div class="time">${messageCount} message${messageCount !== 1 ? 's' : ''} â€¢ ${timeText}</div>
                    </div>
                    <button class="history-delete" data-conv-id="${conv.id}" title="Delete">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 6L6 18M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            `}).join('');

            // Double-click on title to rename
            historyList.querySelectorAll('.query').forEach(titleEl => {
                let clickTimer = null;

                titleEl.addEventListener('click', (e) => {
                    e.stopPropagation();

                    if (clickTimer) {
                        // Double click detected
                        clearTimeout(clickTimer);
                        clickTimer = null;

                        const convId = titleEl.dataset.convId;
                        const conv = conversations.find(c => c.id === convId);
                        if (!conv) return;

                        // Create input element
                        const currentTitle = conv.title;
                        titleEl.classList.add('editing');
                        titleEl.innerHTML = `<input type="text" value="${escapeHtml(currentTitle)}" />`;

                        const input = titleEl.querySelector('input');
                        input.focus();
                        input.select();

                        // Save on blur or Enter
                        const saveRename = () => {
                            const newTitle = input.value.trim();
                            if (newTitle && newTitle !== currentTitle) {
                                renameConversation(convId, newTitle);
                            } else {
                                titleEl.classList.remove('editing');
                                titleEl.textContent = currentTitle;
                            }
                        };

                        input.addEventListener('blur', saveRename);
                        input.addEventListener('keydown', (e) => {
                            if (e.key === 'Enter') {
                                e.preventDefault();
                                input.blur();
                            } else if (e.key === 'Escape') {
                                e.preventDefault();
                                titleEl.classList.remove('editing');
                                titleEl.textContent = currentTitle;
                            }
                        });
                    } else {
                        // First click - load conversation after delay
                        clickTimer = setTimeout(() => {
                            clickTimer = null;
                            const convId = titleEl.closest('.history-item').dataset.convId;
                            loadConversation(convId);
                        }, 250);
                    }
                });
            });

            // Delete individual
            historyList.querySelectorAll('.history-delete').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const convId = btn.dataset.convId;

                    // Remove conversation
                    conversations = conversations.filter(c => c.id !== convId);

                    // If deleting active conversation, clear it
                    if (convId === activeConversationId) {
                        activeConversationId = null;
                        localStorage.removeItem('activeConversationId');
                    }

                    saveConversations();
                    renderHistory();
                });
            });
        }
        
        // Load a past conversation into the chat
        function loadConversation(convId) {
            const conv = conversations.find(c => c.id === convId);
            if (!conv) return;

            // Set as active conversation
            activeConversationId = convId;
            localStorage.setItem('activeConversationId', convId);
            lastActivityTime = Date.now();

            // Clear current messages
            messagesDiv.innerHTML = `
                <div class="message assistant">
                    <div class="message-content">
                        Hi! I'm your marketing data assistant. Ask me anything about your
                        Google Shopping data, GA4 analytics, ad campaigns, inventory, or SEO rankings.
                    </div>
                </div>
            `;

            // Render all messages in the conversation
            conv.messages.forEach(msg => {
                if (msg.role === 'user') {
                    addMessage(msg.content, 'user');
                } else {
                    // Assistant message
                    // Note: Data is no longer stored for performance reasons
                    const answerWithNote = msg.dataRowCount > 0
                        ? msg.content + `\n\n*Note: Data table (${msg.dataRowCount} rows) not available in history. Continue conversation to run new queries.*`
                        : msg.content;
                    addMessage(answerWithNote, 'assistant', msg.sql, null);
                }
            });

            // Refresh history display to show active state
            renderHistory();
        }

        // Clear all conversations
        function clearAllHistory() {
            if (confirm('Delete all conversations?')) {
                conversations = [];
                activeConversationId = null;
                localStorage.setItem('conversations', JSON.stringify(conversations));
                localStorage.removeItem('activeConversationId');
                renderHistory();

                // Clear messages
                messagesDiv.innerHTML = `
                    <div class="message assistant">
                        <div class="message-content">
                            Hi! I'm your marketing data assistant. Ask me anything about your
                            Google Shopping data, GA4 analytics, ad campaigns, inventory, or SEO rankings.
                        </div>
                    </div>
                `;
            }
        }

        // Render downloads
        function renderDownloads() {
            if (downloads.length === 0) {
                downloadsList.innerHTML = '<div class="no-downloads">No downloads yet</div>';
                return;
            }
            downloadsList.innerHTML = downloads.slice().reverse().slice(0, 5).map(d => `
                <div class="download-item" data-url="${d.url}">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6M8 13h8M8 17h8"/>
                    </svg>
                    <span class="name">${escapeHtml(d.name)}</span>
                    <span class="size">${d.size}</span>
                </div>
            `).join('');
            
            downloadsList.querySelectorAll('.download-item').forEach(el => {
                el.addEventListener('click', () => {
                    const a = document.createElement('a');
                    a.href = el.dataset.url;
                    a.download = '';
                    a.click();
                });
            });
        }

        // Conversation Management Functions

        function getOrCreateActiveConversation() {
            const now = Date.now();
            const timeSinceLastActivity = now - lastActivityTime;

            // Check if we should start a new session
            if (!activeConversationId || timeSinceLastActivity > SESSION_TIMEOUT) {
                // Create new conversation
                const convId = `conv-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                const newConv = {
                    id: convId,
                    title: 'New Conversation', // Will be updated with first query
                    created: new Date().toISOString(),
                    lastActive: new Date().toISOString(),
                    messages: []
                };
                conversations.unshift(newConv); // Add to beginning
                activeConversationId = convId;
                localStorage.setItem('activeConversationId', convId);
            }

            lastActivityTime = now;
            return conversations.find(c => c.id === activeConversationId);
        }

        function addMessageToConversation(role, content, sql = null, data = null) {
            const conv = getOrCreateActiveConversation();
            if (!conv) return;

            const now = new Date();
            const timestamp = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            const message = {
                role,
                content,
                timestamp
            };

            // Add metadata for assistant messages
            if (role === 'assistant') {
                message.sql = sql || null;
                message.dataRowCount = data ? data.length : 0;
                message.dataColumns = data && data.length > 0 ? Object.keys(data[0]).join(', ') : null;
            }

            conv.messages.push(message);
            conv.lastActive = now.toISOString();

            // Auto-title from first user message
            if (role === 'user' && conv.messages.length === 1) {
                conv.title = content.substring(0, 50) + (content.length > 50 ? '...' : '');
            }

            saveConversations();
            renderHistory();
        }

        function saveConversations() {
            // Keep only last 50 conversations
            if (conversations.length > 50) {
                conversations = conversations.slice(0, 50);
            }

            try {
                localStorage.setItem('conversations', JSON.stringify(conversations));
            } catch (e) {
                console.warn('localStorage quota exceeded, clearing old conversations');
                conversations = conversations.slice(0, 25);
                localStorage.setItem('conversations', JSON.stringify(conversations));
            }
        }

        function startNewChat() {
            activeConversationId = null;
            localStorage.removeItem('activeConversationId');
            lastActivityTime = 0; // Force new conversation

            // Clear messages
            messagesDiv.innerHTML = `
                <div class="message assistant">
                    <div class="message-content">
                        Hi! I'm your marketing data assistant. Ask me anything about your
                        Google Shopping data, GA4 analytics, ad campaigns, inventory, or SEO rankings.
                    </div>
                </div>
            `;

            renderHistory();
        }

        // ===== PIN Management =====

        function showPinSetupBanner() {
            const banner = document.getElementById('pin-banner');
            banner.style.display = 'flex';
        }

        function hidePinSetupBanner() {
            const banner = document.getElementById('pin-banner');
            banner.style.display = 'none';
        }

        function showPinModal() {
            const modal = document.getElementById('pin-modal');
            const overlay = document.getElementById('overlay');
            modal.style.display = 'flex';
            overlay.classList.add('active');
            document.getElementById('pin-input').value = '';
            document.getElementById('pin-confirm').value = '';
            document.getElementById('pin-error').style.display = 'none';
        }

        function hidePinModal() {
            const modal = document.getElementById('pin-modal');
            const overlay = document.getElementById('overlay');
            modal.style.display = 'none';
            overlay.classList.remove('active');
        }

        function showRecoveryModal() {
            const modal = document.getElementById('pin-recovery-modal');
            const overlay = document.getElementById('overlay');
            modal.style.display = 'flex';
            overlay.classList.add('active');
            document.getElementById('recovery-pin-input').value = '';
            document.getElementById('recovery-pin-error').style.display = 'none';
        }

        function hideRecoveryModal() {
            const modal = document.getElementById('pin-recovery-modal');
            const overlay = document.getElementById('overlay');
            modal.style.display = 'none';
            overlay.classList.remove('active');
        }

        async function registerPin(pin) {
            try {
                const response = await fetch('/api/user/register-pin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pin, userId })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to register PIN');
                }

                return { success: true };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        async function recoverUserId(pin) {
            try {
                const response = await fetch('/api/user/recover-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pin })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to recover user ID');
                }

                return { success: true, userId: data.userId };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        // Event Listeners for PIN UI
        document.getElementById('setup-pin-btn').addEventListener('click', () => {
            hidePinSetupBanner();
            showPinModal();
        });

        document.getElementById('pin-banner-close').addEventListener('click', hidePinSetupBanner);
        document.getElementById('pin-modal-close').addEventListener('click', hidePinModal);
        document.getElementById('pin-cancel-btn').addEventListener('click', hidePinModal);

        document.getElementById('pin-save-btn').addEventListener('click', async () => {
            const pinInput = document.getElementById('pin-input');
            const pinConfirm = document.getElementById('pin-confirm');
            const errorDiv = document.getElementById('pin-error');

            const pin = pinInput.value.trim();
            const confirmPin = pinConfirm.value.trim();

            // Validation
            if (!pin || !confirmPin) {
                errorDiv.textContent = 'Please enter and confirm your PIN';
                errorDiv.style.display = 'block';
                return;
            }

            if (!/^\d{4,8}$/.test(pin)) {
                errorDiv.textContent = 'PIN must be 4-8 digits';
                errorDiv.style.display = 'block';
                return;
            }

            if (pin !== confirmPin) {
                errorDiv.textContent = 'PINs do not match';
                errorDiv.style.display = 'block';
                return;
            }

            // Register PIN
            const result = await registerPin(pin);

            if (result.success) {
                hidePinModal();
                alert('PIN set successfully! You can now use this PIN to access your conversations from any browser.');
            } else {
                errorDiv.textContent = result.error;
                errorDiv.style.display = 'block';
            }
        });

        document.getElementById('recovery-submit-btn').addEventListener('click', async () => {
            const pinInput = document.getElementById('recovery-pin-input');
            const errorDiv = document.getElementById('recovery-pin-error');

            const pin = pinInput.value.trim();

            if (!pin) {
                errorDiv.textContent = 'Please enter your PIN';
                errorDiv.style.display = 'block';
                return;
            }

            if (!/^\d{4,8}$/.test(pin)) {
                errorDiv.textContent = 'PIN must be 4-8 digits';
                errorDiv.style.display = 'block';
                return;
            }

            // Attempt recovery
            const result = await recoverUserId(pin);

            if (result.success) {
                // Restore user ID
                userId = result.userId;
                localStorage.setItem('userId', userId);

                hideRecoveryModal();
                alert('Welcome back! Your conversations have been restored.');
                location.reload(); // Reload to fetch user's conversations
            } else {
                errorDiv.textContent = result.error;
                errorDiv.style.display = 'block';
            }
        });

        document.getElementById('recovery-cancel-btn').addEventListener('click', () => {
            hideRecoveryModal();
            // User chose to start fresh - keep the newly generated userId
        });

        // Download CSV
        downloadCsvBtn.addEventListener('click', () => {
            if (!currentData || currentData.length === 0) return;
            
            const headers = Object.keys(currentData[0]);
            const csvRows = [headers.join(',')];
            
            for (const row of currentData) {
                const values = headers.map(h => {
                    const val = row[h] ?? '';
                    return `"${String(val).replace(/"/g, '""')}"`;
                });
                csvRows.push(values.join(','));
            }
            
            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const filename = `umip-export-${Date.now()}.csv`;
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            
            // Add to downloads
            const size = (blob.size / 1024).toFixed(1) + ' KB';
            downloads.push({ name: filename, url, size });
            if (downloads.length > 10) downloads.shift();
            localStorage.setItem('downloads', JSON.stringify(downloads));
            renderDownloads();
        });

        // Copy data
        copyDataBtn.addEventListener('click', () => {
            if (!currentData || currentData.length === 0) return;
            
            const headers = Object.keys(currentData[0]);
            const rows = [headers.join('\t')];
            
            for (const row of currentData) {
                rows.push(headers.map(h => row[h] ?? '').join('\t'));
            }
            
            navigator.clipboard.writeText(rows.join('\n'));
            copyDataBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg> Copied!';
            setTimeout(() => {
                copyDataBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg> Copy';
            }, 2000);
        });

        function addMessage(content, role, sql = null, data = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            let formattedContent = escapeHtml(content)
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/## (.*?)(?:\n|$)/g, '<strong style="display:block;margin-top:12px;margin-bottom:4px;">$1</strong>')
                .replace(/\n/g, '<br>');
            
            let html = `<div class="message-content">${formattedContent}</div>`;
            
            const chartConfig = data ? detectChartableData(data) : null;
            
            if (sql || (data && data.length > 0) || chartConfig) {
                html += '<div class="message-extras">';
                
                if (sql) {
                    html += `
                        <button class="extras-btn view-sql-btn">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M16 18l6-6-6-6M8 6l-6 6 6 6"/>
                            </svg>
                            View SQL
                        </button>
                    `;
                }
                
                if (data && data.length > 0) {
                    html += `
                        <button class="extras-btn view-data-btn">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 3v18"/>
                            </svg>
                            View Data (${data.length} rows)
                        </button>
                    `;
                }
                
                if (chartConfig) {
                    html += `
                        <button class="extras-btn view-chart-btn">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 3v18h18"/><path d="M18 9l-5 5-4-4-3 3"/>
                            </svg>
                            View Chart
                        </button>
                    `;
                }
                
                html += '</div>';
            }
            
            messageDiv.innerHTML = html;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            // Attach event listeners
            const sqlBtn = messageDiv.querySelector('.view-sql-btn');
            if (sqlBtn && sql) {
                sqlBtn.addEventListener('click', () => openSqlModal(sql));
            }
            
            const dataBtn = messageDiv.querySelector('.view-data-btn');
            if (dataBtn && data) {
                dataBtn.addEventListener('click', () => openDataPanel(data));
            }
            
            const chartBtn = messageDiv.querySelector('.view-chart-btn');
            if (chartBtn && chartConfig) {
                chartBtn.addEventListener('click', () => openChartModal(data, 'Trend Analysis'));
            }
        }

        // Paginated table rendering - only shows 100 rows at a time
        let currentPage = 1;
        const rowsPerPage = 100;
        let columnOrder = [];
        let sortColumn = null;
        let sortDirection = 'asc';

        function createTable(data) {
            if (!data || data.length === 0) return '<p style="padding:20px;color:var(--text-secondary);">No data</p>';

            // Initialize column order if not set
            if (columnOrder.length === 0) {
                columnOrder = Object.keys(data[0]);
            }

            const columns = columnOrder;
            const totalRows = data.length;
            const totalPages = Math.ceil(totalRows / rowsPerPage);

            // Calculate pagination
            const startIdx = (currentPage - 1) * rowsPerPage;
            const endIdx = Math.min(startIdx + rowsPerPage, totalRows);
            const pageData = data.slice(startIdx, endIdx);

            // Build pagination controls
            let paginationHtml = '';
            if (totalPages > 1) {
                paginationHtml = `
                    <div style="padding:12px;border-bottom:1px solid var(--border-color);display:flex;align-items:center;justify-content:space-between;background:var(--bg-secondary);">
                        <div style="font-size:13px;color:var(--text-secondary);">
                            Showing ${startIdx + 1}-${endIdx} of ${totalRows} rows
                        </div>
                        <div style="display:flex;gap:8px;align-items:center;">
                            <button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}
                                style="padding:4px 12px;border:1px solid var(--border-color);background:var(--bg-primary);cursor:pointer;border-radius:4px;font-size:12px;"
                                ${currentPage === 1 ? 'style="opacity:0.5;cursor:not-allowed;"' : ''}>
                                Previous
                            </button>
                            <span style="font-size:13px;color:var(--text-primary);">Page ${currentPage} of ${totalPages}</span>
                            <button onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}
                                style="padding:4px 12px;border:1px solid var(--border-color);background:var(--bg-primary);cursor:pointer;border-radius:4px;font-size:12px;"
                                ${currentPage === totalPages ? 'style="opacity:0.5;cursor:not-allowed;"' : ''}>
                                Next
                            </button>
                        </div>
                    </div>
                `;
            }

            // Build table with only current page data
            let html = paginationHtml + '<table class="data-table"><thead><tr>';

            columns.forEach(col => {
                const sortClass = sortColumn === col ? `sorted-${sortDirection}` : '';
                html += `<th class="${sortClass}" data-column="${escapeHtml(col)}" draggable="true">
                    ${escapeHtml(col)}
                    <span class="sort-indicator"></span>
                </th>`;
            });

            html += '</tr></thead><tbody>';

            pageData.forEach(row => {
                html += '<tr>';
                columns.forEach(col => {
                    const val = row[col] !== null ? row[col] : '';
                    html += `<td>${escapeHtml(String(val))}</td>`;
                });
                html += '</tr>';
            });

            html += '</tbody></table>';

            // After rendering, attach event listeners
            setTimeout(() => attachTableEventListeners(), 0);

            return html;
        }

        // Attach sorting and drag-drop event listeners to table headers
        function attachTableEventListeners() {
            const headers = dataTableContainer.querySelectorAll('.data-table th');

            headers.forEach(header => {
                // Click to sort
                header.addEventListener('click', () => {
                    const column = header.dataset.column;
                    sortTable(column);
                });

                // Drag and drop for column reordering
                header.addEventListener('dragstart', (e) => {
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', header.dataset.column);
                    header.classList.add('dragging');
                });

                header.addEventListener('dragend', () => {
                    header.classList.remove('dragging');
                    headers.forEach(h => h.classList.remove('drag-over'));
                });

                header.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                });

                header.addEventListener('dragenter', (e) => {
                    e.preventDefault();
                    header.classList.add('drag-over');
                });

                header.addEventListener('dragleave', () => {
                    header.classList.remove('drag-over');
                });

                header.addEventListener('drop', (e) => {
                    e.preventDefault();
                    header.classList.remove('drag-over');

                    const draggedColumn = e.dataTransfer.getData('text/plain');
                    const targetColumn = header.dataset.column;

                    if (draggedColumn !== targetColumn) {
                        reorderColumns(draggedColumn, targetColumn);
                    }
                });
            });
        }

        // Sort table by column
        function sortTable(column) {
            if (!currentData) return;

            // Toggle sort direction if clicking the same column
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }

            // Sort the data
            currentData.sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];

                // Handle null/undefined
                if (aVal === null || aVal === undefined) return 1;
                if (bVal === null || bVal === undefined) return -1;

                // Try to parse as numbers
                const aNum = parseFloat(aVal);
                const bNum = parseFloat(bVal);

                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return sortDirection === 'asc' ? aNum - bNum : bNum - aNum;
                }

                // String comparison
                const aStr = String(aVal).toLowerCase();
                const bStr = String(bVal).toLowerCase();

                if (sortDirection === 'asc') {
                    return aStr < bStr ? -1 : aStr > bStr ? 1 : 0;
                } else {
                    return aStr > bStr ? -1 : aStr < bStr ? 1 : 0;
                }
            });

            // Reset to first page and re-render
            currentPage = 1;
            dataTableContainer.innerHTML = createTable(currentData);
        }

        // Reorder columns
        function reorderColumns(draggedColumn, targetColumn) {
            const draggedIndex = columnOrder.indexOf(draggedColumn);
            const targetIndex = columnOrder.indexOf(targetColumn);

            if (draggedIndex === -1 || targetIndex === -1) return;

            // Remove dragged column and insert at target position
            columnOrder.splice(draggedIndex, 1);
            const newTargetIndex = columnOrder.indexOf(targetColumn);
            columnOrder.splice(newTargetIndex, 0, draggedColumn);

            // Re-render table with new column order
            dataTableContainer.innerHTML = createTable(currentData);
        }

        // Page navigation
        function changePage(newPage) {
            if (!currentData) return;
            const totalPages = Math.ceil(currentData.length / rowsPerPage);
            if (newPage < 1 || newPage > totalPages) return;
            currentPage = newPage;
            dataTableContainer.innerHTML = createTable(currentData);
        }

        // Make changePage available globally for inline onclick handlers
        window.changePage = changePage;
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function setLoading(loading) {
            sendBtn.disabled = loading;
            userInput.disabled = loading;
            
            if (loading) {
                sendBtn.innerHTML = '<span class="spinner"></span>';
                const thinkingDiv = document.createElement('div');
                thinkingDiv.className = 'message assistant thinking';
                thinkingDiv.id = 'thinking-indicator';
                thinkingDiv.innerHTML = `
                    <div class="message-content">
                        <div class="dot-pulse"><span></span><span></span><span></span></div>
                        Analyzing your data...
                    </div>
                `;
                messagesDiv.appendChild(thinkingDiv);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            } else {
                sendBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13M22 2L15 22L11 13M11 13L2 9L22 2"/></svg>';
                const thinking = document.getElementById('thinking-indicator');
                if (thinking) thinking.remove();
            }
        }
        
        // Optimized streaming - types out the response with better performance
        async function typeMessage(content, messageDiv, sql, data) {
            const contentDiv = messageDiv.querySelector('.message-content');

            // PRE-FORMAT: Format once instead of per word (97% CPU reduction)
            const formatted = escapeHtml(content)
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/## (.*?)(?:\n|$)/g, '<strong style="display:block;margin-top:12px;margin-bottom:4px;">$1</strong>')
                .replace(/\n/g, '<br>');

            const words = content.split(' ');
            let wordIndex = 0;
            let skipAnimation = false;

            // Add skip button for instant display
            const skipBtn = document.createElement('button');
            skipBtn.className = 'skip-animation-btn';
            skipBtn.innerHTML = 'Skip';
            skipBtn.style.cssText = 'position:absolute;top:8px;right:8px;padding:4px 8px;font-size:11px;background:var(--accent);color:white;border:none;border-radius:4px;cursor:pointer;z-index:10;opacity:0.8;transition:opacity 0.2s;';
            skipBtn.onmouseover = () => skipBtn.style.opacity = '1';
            skipBtn.onmouseout = () => skipBtn.style.opacity = '0.8';
            skipBtn.onclick = () => { skipAnimation = true; };
            messageDiv.style.position = 'relative';
            messageDiv.appendChild(skipBtn);

            // Throttle scroll updates (once per 50ms instead of per word)
            let lastScrollTime = 0;
            const scrollThrottle = 50;

            for (let i = 0; i < words.length; i++) {
                if (skipAnimation) break;

                wordIndex = i;

                // Calculate character position for current word
                const wordsToShow = words.slice(0, i + 1).join(' ');
                const charsToShow = wordsToShow.length;
                const totalChars = content.length;
                const percentage = charsToShow / totalChars;

                // Use substring of pre-formatted HTML (approximate)
                const approximateHtml = formatted.substring(0, Math.floor(formatted.length * percentage));
                contentDiv.innerHTML = approximateHtml + '<span class="streaming-cursor"></span>';

                // Throttled scroll update
                const now = Date.now();
                if (now - lastScrollTime > scrollThrottle) {
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                    lastScrollTime = now;
                }

                // Reduced delay: 5ms instead of 15ms (67% faster)
                await new Promise(r => setTimeout(r, 5));
            }

            // Remove skip button
            skipBtn.remove();

            // Final render with full content and extras
            let html = `<div class="message-content">${formatted}</div>`;

            const chartConfig = data ? detectChartableData(data) : null;

            if (sql || (data && data.length > 0) || chartConfig) {
                html += '<div class="message-extras">';
                if (sql) {
                    html += `<button class="extras-btn view-sql-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 18l6-6-6-6M8 6l-6 6 6 6"/></svg> View SQL</button>`;
                }
                if (data && data.length > 0) {
                    html += `<button class="extras-btn view-data-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 3v18"/></svg> View Data (${data.length} rows)</button>`;
                }
                if (chartConfig) {
                    html += `<button class="extras-btn view-chart-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="M18 9l-5 5-4-4-3 3"/></svg> View Chart</button>`;
                }
                html += '</div>';
            }

            messageDiv.innerHTML = html;

            // Final scroll
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            const sqlBtn = messageDiv.querySelector('.view-sql-btn');
            if (sqlBtn && sql) sqlBtn.addEventListener('click', () => openSqlModal(sql));

            const dataBtn = messageDiv.querySelector('.view-data-btn');
            if (dataBtn && data) dataBtn.addEventListener('click', () => openDataPanel(data));

            const chartBtn = messageDiv.querySelector('.view-chart-btn');
            if (chartBtn && chartConfig) chartBtn.addEventListener('click', () => openChartModal(data, 'Trend Analysis'));
        }
        
        // Real-time streaming function
        async function sendMessageStream(message) {
            setLoading(true);

            // Create message div for streaming content
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant';
            messageDiv.style.position = 'relative';
            messageDiv.innerHTML = '<div class="message-content"><span class="streaming-cursor"></span></div>';
            messagesDiv.appendChild(messageDiv);

            const contentDiv = messageDiv.querySelector('.message-content');
            let fullAnswer = '';
            let currentSql = null;
            let currentData = null;
            let rowCount = 0;

            try {
                const response = await fetch('/api/chat/stream', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n\n');
                    buffer = lines.pop() || '';

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const eventData = JSON.parse(line.slice(6));

                            switch (eventData.type) {
                                case 'token':
                                    // Append token to answer in real-time
                                    fullAnswer += eventData.content;
                                    const formatted = escapeHtml(fullAnswer)
                                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                                        .replace(/## (.*?)(?:\n|$)/g, '<strong style="display:block;margin-top:12px;margin-bottom:4px;">$1</strong>')
                                        .replace(/\n/g, '<br>');
                                    contentDiv.innerHTML = formatted + '<span class="streaming-cursor"></span>';
                                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                                    break;

                                case 'replace_content':
                                    // Replace displayed content (e.g., remove SQL blocks)
                                    fullAnswer = eventData.content;
                                    const replacedFormatted = escapeHtml(fullAnswer)
                                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                                        .replace(/## (.*?)(?:\n|$)/g, '<strong style="display:block;margin-top:12px;margin-bottom:4px;">$1</strong>')
                                        .replace(/\n/g, '<br>');
                                    contentDiv.innerHTML = replacedFormatted + '<span class="streaming-cursor"></span>';
                                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                                    break;

                                case 'sql':
                                    currentSql = eventData.content;
                                    break;

                                case 'status':
                                    // Show status message briefly
                                    const statusSpan = document.createElement('span');
                                    statusSpan.style.cssText = 'color:var(--text-secondary);font-style:italic;font-size:13px;';
                                    statusSpan.textContent = ` [${eventData.content}]`;
                                    contentDiv.appendChild(statusSpan);
                                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                                    break;

                                case 'data_ready':
                                    rowCount = eventData.row_count;
                                    break;

                                case 'complete':
                                    // Final render with all buttons
                                    currentSql = eventData.sql || currentSql;
                                    currentData = eventData.data;

                                    // Format final answer
                                    const finalFormatted = escapeHtml(fullAnswer)
                                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                                        .replace(/## (.*?)(?:\n|$)/g, '<strong style="display:block;margin-top:12px;margin-bottom:4px;">$1</strong>')
                                        .replace(/\n/g, '<br>');

                                    let html = `<div class="message-content">${finalFormatted}</div>`;

                                    const chartConfig = currentData ? detectChartableData(currentData) : null;

                                    if (currentSql || (currentData && currentData.length > 0) || chartConfig) {
                                        html += '<div class="message-extras">';
                                        if (currentSql) {
                                            html += `<button class="extras-btn view-sql-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 18l6-6-6-6M8 6l-6 6 6 6"/></svg> View SQL</button>`;
                                        }
                                        if (currentData && currentData.length > 0) {
                                            html += `<button class="extras-btn view-data-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 3v18"/></svg> View Data (${currentData.length} rows)</button>`;
                                        }
                                        if (chartConfig) {
                                            html += `<button class="extras-btn view-chart-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="M18 9l-5 5-4-4-3 3"/></svg> View Chart</button>`;
                                        }
                                        html += '</div>';
                                    }

                                    messageDiv.innerHTML = html;

                                    // Attach event listeners
                                    const sqlBtn = messageDiv.querySelector('.view-sql-btn');
                                    if (sqlBtn && currentSql) sqlBtn.addEventListener('click', () => openSqlModal(currentSql));

                                    const dataBtn = messageDiv.querySelector('.view-data-btn');
                                    if (dataBtn && currentData) dataBtn.addEventListener('click', () => openDataPanel(currentData));

                                    const chartBtn = messageDiv.querySelector('.view-chart-btn');
                                    if (chartBtn && chartConfig) chartBtn.addEventListener('click', () => openChartModal(currentData, 'Trend Analysis'));

                                    // Save messages to conversation
                                    addMessageToConversation('assistant', fullAnswer, currentSql, currentData);
                                    break;

                                case 'error':
                                    console.error('Stream error:', eventData.content);
                                    break;
                            }
                        }
                    }
                }

                setLoading(false);
            } catch (err) {
                setLoading(false);
                contentDiv.innerHTML = `<span style="color:var(--error);">Failed to connect: ${err.message}</span>`;
                addMessageToConversation('assistant', `Failed to connect: ${err.message}`, null, null);
            } finally {
                userInput.focus();
            }
        }

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const message = userInput.value.trim();
            if (!message) return;

            addMessage(message, 'user');
            addMessageToConversation('user', message); // Save user message to conversation
            userInput.value = '';

            // Use streaming by default
            await sendMessageStream(message);
        });
        
        // Initialize
        renderHistory();
        renderDownloads();
        userInput.focus();
        
        // Clear all history button
        document.getElementById('clear-history-btn').addEventListener('click', clearAllHistory);
        
        // New chat button
        document.getElementById('new-chat-btn').addEventListener('click', () => {
            startNewChat();
            userInput.focus();
        });
    </script>
</body>
</html>